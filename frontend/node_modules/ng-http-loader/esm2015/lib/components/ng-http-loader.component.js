/*
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
import { Component, Input } from '@angular/core';
import { merge, partition, timer } from 'rxjs';
import { debounce, distinctUntilChanged, switchMap, tap } from 'rxjs/operators';
import { PendingRequestsInterceptor } from '../services/pending-requests-interceptor.service';
import { SpinnerVisibilityService } from '../services/spinner-visibility.service';
import { Spinkit } from '../spinkits';
export class NgHttpLoaderComponent {
    constructor(pendingRequestsInterceptor, spinnerVisibility) {
        this.pendingRequestsInterceptor = pendingRequestsInterceptor;
        this.spinnerVisibility = spinnerVisibility;
        this.spinkit = Spinkit;
        this.visibleUntil = Date.now();
        this.backdrop = true;
        this.debounceDelay = 0;
        this.entryComponent = null;
        this.extraDuration = 0;
        this.filteredHeaders = [];
        this.filteredMethods = [];
        this.filteredUrlPatterns = [];
        this.minDuration = 0;
        this.opacity = '.7';
        this.backdropBackgroundColor = '#f1f1f1';
        this.spinner = Spinkit.skWave;
    }
    ngOnInit() {
        this.initIsvisibleObservable();
        this.nullifySpinnerIfEntryComponentIsDefined();
        this.initFilters();
    }
    initIsvisibleObservable() {
        const [showSpinner$, hideSpinner$] = partition(this.pendingRequestsInterceptor.pendingRequestsStatus$, h => h);
        this.isVisible$ = merge(this.pendingRequestsInterceptor.pendingRequestsStatus$
            .pipe(switchMap(() => showSpinner$.pipe(debounce(() => timer(this.debounceDelay))))), showSpinner$
            .pipe(switchMap(() => hideSpinner$.pipe(debounce(() => this.getVisibilityTimer$())))), this.spinnerVisibility.visibility$).pipe(distinctUntilChanged(), tap(h => this.updateExpirationDelay(h)));
    }
    nullifySpinnerIfEntryComponentIsDefined() {
        if (this.entryComponent) {
            this.spinner = null;
        }
    }
    initFilters() {
        this.initFilteredUrlPatterns();
        this.initFilteredMethods();
        this.initFilteredHeaders();
    }
    initFilteredUrlPatterns() {
        if (!!this.filteredUrlPatterns.length) {
            this.filteredUrlPatterns.forEach(e => this.pendingRequestsInterceptor.filteredUrlPatterns.push(new RegExp(e)));
        }
    }
    initFilteredMethods() {
        this.pendingRequestsInterceptor.filteredMethods = this.filteredMethods;
    }
    initFilteredHeaders() {
        this.pendingRequestsInterceptor.filteredHeaders = this.filteredHeaders;
    }
    updateExpirationDelay(showSpinner) {
        if (showSpinner) {
            this.visibleUntil = Date.now() + this.minDuration;
        }
    }
    getVisibilityTimer$() {
        return timer(Math.max(this.extraDuration, this.visibleUntil - Date.now()));
    }
}
NgHttpLoaderComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-http-loader',
                template: "<div id=\"spinner\"\n     *ngIf=\"isVisible$ | async\"\n     [class.backdrop]=\"backdrop\"\n     [style.opacity]=\"opacity\"\n     [ngStyle]=\"{'background-color': backdrop ? backdropBackgroundColor : 'transparent'}\">\n\n    <ng-container *ngComponentOutlet=\"entryComponent\"></ng-container>\n\n    <sk-cube-grid\n        *ngIf=\"spinner === spinkit.skCubeGrid\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-cube-grid>\n\n    <sk-chasing-dots\n        *ngIf=\"spinner === spinkit.skChasingDots\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-chasing-dots>\n\n    <sk-double-bounce\n        *ngIf=\"spinner === spinkit.skDoubleBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-double-bounce>\n\n    <sk-rotating-plane\n        *ngIf=\"spinner === spinkit.skRotatingPlane\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-rotating-plane>\n\n    <sk-spinner-pulse\n        *ngIf=\"spinner === spinkit.skSpinnerPulse\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-spinner-pulse>\n\n    <sk-three-bounce\n        *ngIf=\"spinner === spinkit.skThreeBounce\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-three-bounce>\n\n    <sk-wandering-cubes\n        *ngIf=\"spinner === spinkit.skWanderingCubes\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wandering-cubes>\n\n    <sk-wave\n        *ngIf=\"spinner === spinkit.skWave\"\n        [backgroundColor]=\"backgroundColor\">\n    </sk-wave>\n\n</div>\n\n",
                styles: ["#spinner{left:50%;position:fixed;top:50%;transform:translate(-50%,-50%);z-index:9999}#spinner.backdrop{align-items:center;display:flex;height:100%;justify-content:center;left:0;top:0;transform:none;width:100%}::ng-deep .colored-parent,::ng-deep .colored>div{background-color:#333}"]
            },] }
];
NgHttpLoaderComponent.ctorParameters = () => [
    { type: PendingRequestsInterceptor },
    { type: SpinnerVisibilityService }
];
NgHttpLoaderComponent.propDecorators = {
    backdrop: [{ type: Input }],
    backgroundColor: [{ type: Input }],
    debounceDelay: [{ type: Input }],
    entryComponent: [{ type: Input }],
    extraDuration: [{ type: Input }],
    filteredHeaders: [{ type: Input }],
    filteredMethods: [{ type: Input }],
    filteredUrlPatterns: [{ type: Input }],
    minDuration: [{ type: Input }],
    opacity: [{ type: Input }],
    backdropBackgroundColor: [{ type: Input }],
    spinner: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctaHR0cC1sb2FkZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL25nLWh0dHAtbG9hZGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztHQU9HO0FBRUgsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUFFLEtBQUssRUFBYyxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNELE9BQU8sRUFBRSxRQUFRLEVBQUUsb0JBQW9CLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBQzlGLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ2xGLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFPdEMsTUFBTSxPQUFPLHFCQUFxQjtJQW1COUIsWUFBb0IsMEJBQXNELEVBQVUsaUJBQTJDO1FBQTNHLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNEI7UUFBVSxzQkFBaUIsR0FBakIsaUJBQWlCLENBQTBCO1FBakJ4SCxZQUFPLEdBQUcsT0FBTyxDQUFDO1FBRWpCLGlCQUFZLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRWxCLGFBQVEsR0FBRyxJQUFJLENBQUM7UUFFaEIsa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFDbEIsbUJBQWMsR0FBUSxJQUFJLENBQUM7UUFDM0Isa0JBQWEsR0FBRyxDQUFDLENBQUM7UUFDbEIsb0JBQWUsR0FBYSxFQUFFLENBQUM7UUFDL0Isb0JBQWUsR0FBYSxFQUFFLENBQUM7UUFDL0Isd0JBQW1CLEdBQWEsRUFBRSxDQUFDO1FBQ25DLGdCQUFXLEdBQUcsQ0FBQyxDQUFDO1FBQ2hC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QXdCOzs7dUJBYzVCLEtBQUs7OEJBQ0wsS0FBSzs0QkFDTCxLQUFLOzZCQUNMLEtBQUs7NEJBQ0wsS0FBSzs4QkFDTCxLQUFLOzhCQUNMLEtBQUs7a0NBQ0wsS0FBSzswQkFDTCxLQUFLO3NCQUNMLEtBQUs7c0NBQ0wsS0FBSztzQkFDTCxLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTXG4gKiBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1JcbiAqIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUlxuICogSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU5cbiAqIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBtZXJnZSwgT2JzZXJ2YWJsZSwgcGFydGl0aW9uLCB0aW1lciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZGVib3VuY2UsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBzd2l0Y2hNYXAsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFBlbmRpbmdSZXF1ZXN0c0ludGVyY2VwdG9yIH0gZnJvbSAnLi4vc2VydmljZXMvcGVuZGluZy1yZXF1ZXN0cy1pbnRlcmNlcHRvci5zZXJ2aWNlJztcbmltcG9ydCB7IFNwaW5uZXJWaXNpYmlsaXR5U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL3NwaW5uZXItdmlzaWJpbGl0eS5zZXJ2aWNlJztcbmltcG9ydCB7IFNwaW5raXQgfSBmcm9tICcuLi9zcGlua2l0cyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnbmctaHR0cC1sb2FkZXInLFxuICAgIHRlbXBsYXRlVXJsOiAnLi9uZy1odHRwLWxvYWRlci5jb21wb25lbnQuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vbmctaHR0cC1sb2FkZXIuY29tcG9uZW50LnNjc3MnXVxufSlcbmV4cG9ydCBjbGFzcyBOZ0h0dHBMb2FkZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuXG4gICAgcHVibGljIHNwaW5raXQgPSBTcGlua2l0O1xuICAgIHB1YmxpYyBpc1Zpc2libGUkITogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgICBwcml2YXRlIHZpc2libGVVbnRpbCA9IERhdGUubm93KCk7XG5cbiAgICBASW5wdXQoKSBwdWJsaWMgYmFja2Ryb3AgPSB0cnVlO1xuICAgIEBJbnB1dCgpIHB1YmxpYyBiYWNrZ3JvdW5kQ29sb3IhOiBzdHJpbmc7XG4gICAgQElucHV0KCkgcHVibGljIGRlYm91bmNlRGVsYXkgPSAwO1xuICAgIEBJbnB1dCgpIHB1YmxpYyBlbnRyeUNvbXBvbmVudDogYW55ID0gbnVsbDtcbiAgICBASW5wdXQoKSBwdWJsaWMgZXh0cmFEdXJhdGlvbiA9IDA7XG4gICAgQElucHV0KCkgcHVibGljIGZpbHRlcmVkSGVhZGVyczogc3RyaW5nW10gPSBbXTtcbiAgICBASW5wdXQoKSBwdWJsaWMgZmlsdGVyZWRNZXRob2RzOiBzdHJpbmdbXSA9IFtdO1xuICAgIEBJbnB1dCgpIHB1YmxpYyBmaWx0ZXJlZFVybFBhdHRlcm5zOiBzdHJpbmdbXSA9IFtdO1xuICAgIEBJbnB1dCgpIHB1YmxpYyBtaW5EdXJhdGlvbiA9IDA7XG4gICAgQElucHV0KCkgcHVibGljIG9wYWNpdHkgPSAnLjcnO1xuICAgIEBJbnB1dCgpIHB1YmxpYyBiYWNrZHJvcEJhY2tncm91bmRDb2xvciA9ICcjZjFmMWYxJztcbiAgICBASW5wdXQoKSBwdWJsaWMgc3Bpbm5lcjogc3RyaW5nIHwgbnVsbCA9IFNwaW5raXQuc2tXYXZlO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwZW5kaW5nUmVxdWVzdHNJbnRlcmNlcHRvcjogUGVuZGluZ1JlcXVlc3RzSW50ZXJjZXB0b3IsIHByaXZhdGUgc3Bpbm5lclZpc2liaWxpdHk6IFNwaW5uZXJWaXNpYmlsaXR5U2VydmljZSkge1xuICAgIH1cblxuICAgIHB1YmxpYyBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5pbml0SXN2aXNpYmxlT2JzZXJ2YWJsZSgpO1xuICAgICAgICB0aGlzLm51bGxpZnlTcGlubmVySWZFbnRyeUNvbXBvbmVudElzRGVmaW5lZCgpO1xuICAgICAgICB0aGlzLmluaXRGaWx0ZXJzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0SXN2aXNpYmxlT2JzZXJ2YWJsZSgpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgW3Nob3dTcGlubmVyJCwgaGlkZVNwaW5uZXIkXSA9IHBhcnRpdGlvbih0aGlzLnBlbmRpbmdSZXF1ZXN0c0ludGVyY2VwdG9yLnBlbmRpbmdSZXF1ZXN0c1N0YXR1cyQsIGggPT4gaCk7XG5cbiAgICAgICAgdGhpcy5pc1Zpc2libGUkID0gbWVyZ2UoXG4gICAgICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0c0ludGVyY2VwdG9yLnBlbmRpbmdSZXF1ZXN0c1N0YXR1cyRcbiAgICAgICAgICAgICAgICAucGlwZShzd2l0Y2hNYXAoKCkgPT4gc2hvd1NwaW5uZXIkLnBpcGUoZGVib3VuY2UoKCkgPT4gdGltZXIodGhpcy5kZWJvdW5jZURlbGF5KSkpKSksXG4gICAgICAgICAgICBzaG93U3Bpbm5lciRcbiAgICAgICAgICAgICAgICAucGlwZShzd2l0Y2hNYXAoKCkgPT4gaGlkZVNwaW5uZXIkLnBpcGUoZGVib3VuY2UoKCkgPT4gdGhpcy5nZXRWaXNpYmlsaXR5VGltZXIkKCkpKSkpLFxuICAgICAgICAgICAgdGhpcy5zcGlubmVyVmlzaWJpbGl0eS52aXNpYmlsaXR5JFxuICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICAgdGFwKGggPT4gdGhpcy51cGRhdGVFeHBpcmF0aW9uRGVsYXkoaCkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBudWxsaWZ5U3Bpbm5lcklmRW50cnlDb21wb25lbnRJc0RlZmluZWQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmVudHJ5Q29tcG9uZW50KSB7XG4gICAgICAgICAgICB0aGlzLnNwaW5uZXIgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVycygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5pbml0RmlsdGVyZWRVcmxQYXR0ZXJucygpO1xuICAgICAgICB0aGlzLmluaXRGaWx0ZXJlZE1ldGhvZHMoKTtcbiAgICAgICAgdGhpcy5pbml0RmlsdGVyZWRIZWFkZXJzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVyZWRVcmxQYXR0ZXJucygpOiB2b2lkIHtcbiAgICAgICAgaWYgKCEhdGhpcy5maWx0ZXJlZFVybFBhdHRlcm5zLmxlbmd0aCkge1xuICAgICAgICAgICAgdGhpcy5maWx0ZXJlZFVybFBhdHRlcm5zLmZvckVhY2goZSA9PlxuICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzSW50ZXJjZXB0b3IuZmlsdGVyZWRVcmxQYXR0ZXJucy5wdXNoKG5ldyBSZWdFeHAoZSkpXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0RmlsdGVyZWRNZXRob2RzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0c0ludGVyY2VwdG9yLmZpbHRlcmVkTWV0aG9kcyA9IHRoaXMuZmlsdGVyZWRNZXRob2RzO1xuICAgIH1cblxuICAgIHByaXZhdGUgaW5pdEZpbHRlcmVkSGVhZGVycygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wZW5kaW5nUmVxdWVzdHNJbnRlcmNlcHRvci5maWx0ZXJlZEhlYWRlcnMgPSB0aGlzLmZpbHRlcmVkSGVhZGVycztcbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZUV4cGlyYXRpb25EZWxheShzaG93U3Bpbm5lcjogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICBpZiAoc2hvd1NwaW5uZXIpIHtcbiAgICAgICAgICAgIHRoaXMudmlzaWJsZVVudGlsID0gRGF0ZS5ub3coKSArIHRoaXMubWluRHVyYXRpb247XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFZpc2liaWxpdHlUaW1lciQoKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICAgICAgcmV0dXJuIHRpbWVyKE1hdGgubWF4KHRoaXMuZXh0cmFEdXJhdGlvbiwgdGhpcy52aXNpYmxlVW50aWwgLSBEYXRlLm5vdygpKSk7XG4gICAgfVxufVxuIl19